(()=>{"use strict";var e={23:function(e,t,n){var o,a=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,a)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),s=0;s<n.length;s++)"default"!==n[s]&&a(t,e,n[s]);return i(t,e),t});Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(414)),l=window.PluginApi,{React:d}=window.PluginApi,{Button:c,ButtonGroup:u,Card:g,FormControl:p,InputGroup:h}=l.libraries.Bootstrap,{faArrowUp:m,faArrowDown:v,faCirclePlay:f,faFilm:b,faImage:T,faImages:C,faLocationDot:E,faPencil:y,faTag:w,faTrash:S,faUser:x,faVideo:I}=l.libraries.FontAwesomeSolid,{Icon:O,LoadingIndicator:_}=l.components;let{TagSelect:N,TagIDSelect:G}=l.components;!N&&l.loadableComponents.TagSelec&&l.utils.loadComponents([l.loadableComponents.TagSelect]).then(()=>{N=l.components.TagSelect}),!G&&l.loadableComponents.TagIDSelect&&l.utils.loadComponents([l.loadableComponents.TagIDSelect]).then(()=>{G=l.components.TagIDSelect});const k=["scene","image","group","gallery","performer","studio","tag"];class P extends d.PureComponent{constructor(e){super(e),this.debounce=(e,t)=>{let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e.apply(this,o),t)}},this.onEditClicked=()=>{this.setState({edit:!0})},this.onUpClicked=()=>{this.props.onUp&&this.props.onUp()},this.onDownClicked=()=>{this.props.onDown&&this.props.onDown()},this.onRemoveClicked=()=>{this.props.onRemove&&this.props.onRemove()},this.onNameChanged=e=>{this.setState({name:e,changed:!0})},this.onColorClassChanged=e=>{this.setState({colorClass:e,changed:!0},()=>{this.onFocusLost()})},this.onToggleContext=e=>{this.setState(t=>{const n=new Set(t.contexts);return t.contexts&&t.contexts.has(e)?n.delete(e):n.add(e),{contexts:n,changed:!0}},()=>{this.onFocusLost()})},this.onConditionChanged=e=>{this.setState({conditionTagId:e,changed:!0},()=>{this.onFocusLost()})},this.onOrderChanged=e=>{const t=void 0!==e?parseInt(e):void 0;this.setState({order:t,changed:!0}),e&&this.onOrderCallback&&this.onOrderCallback(t)},this.onOrderCallback=this.props.onOrder?this.debounce(this.props.onOrder,500):void 0,this.onFocusLost=()=>{this.state.changed&&this.props.onChanged&&this.setState({disabled:!0},()=>{this.props.onChanged(this.state.name,this.state.conditionTagId,this.state.contexts?Array.from(this.state.contexts.values()):void 0,this.state.colorClass).then(()=>this.setState({disabled:!1,changed:!1}),()=>this.setState({disabled:!1,changed:!1}))})},this.state={edit:!1,name:e.item.name,order:e.item.order,contexts:void 0!==e.item.contexts?new Set(e.item.contexts):new Set(k),conditionTagId:e.item.conditionTagId,colorClass:e.item.colorClass,changed:!1,disabled:!1}}render(){var e;return l.components.TagIDSelect?d.createElement(g,{className:"fast-tagger-card"},d.createElement(g.Body,null,!this.state.edit&&d.createElement("div",{className:"mb-1"},d.createElement("h5",null,this.state.name)),this.state.edit&&d.createElement("div",{className:"mb-1"},d.createElement(h,null,d.createElement("input",{name:"name",type:"text",value:this.state.name,onChange:e=>this.onNameChanged(e.target.value),onBlur:e=>this.onFocusLost(),disabled:this.props.disabled||this.state.disabled,placeholder:"Name...",className:"form-control form-control-sm text-input",required:!0}),d.createElement(h.Append,null,d.createElement("select",{className:"form-control form-control-sm"+(this.state.colorClass?" bg-"+this.state.colorClass:""),value:this.state.colorClass,onChange:e=>this.onColorClassChanged(e.target.value),disabled:this.props.disabled||this.state.disabled},d.createElement("option",{value:""},"None"),d.createElement("option",{value:"blue",className:"text-blue"},"Blue"),d.createElement("option",{value:"green",className:"text-green"},"Green"),d.createElement("option",{value:"red",className:"text-red"},"Red"),d.createElement("option",{value:"yellow",className:"text-yellow"},"Yellow"),d.createElement("option",{value:"orange",className:"text-orange"},"Orange"),d.createElement("option",{value:"cyan",className:"text-cyan"},"Cyan"),d.createElement("option",{value:"indigo",className:"text-indigo"},"indigo"),d.createElement("option",{value:"purple",className:"text-purple"},"Purple"),d.createElement("option",{value:"pink",className:"text-pink"},"Pink"),d.createElement("option",{value:"teal",className:"text-teal"},"Teal"),d.createElement("option",{value:"white",className:"text-white"},"White"),d.createElement("option",{value:"gray",className:"text-gray"},"Gray"),d.createElement("option",{value:"gray",className:"text-gray"},"Gray"),d.createElement("option",{value:"gray-dark",className:"text-gray-dark"},"Dark Gray"),d.createElement("option",{value:"transparent",className:"text-transparent"},"Transparent"))))),!this.state.edit&&d.createElement("div",{className:"mb-1 d-flex flex-row"},k.map(e=>{var t;return d.createElement("div",{key:e,className:"m-0 "+((null===(t=this.state.contexts)||void 0===t?void 0:t.has(e))?"text-success":"text-danger")},"scene"==e&&d.createElement(O,{icon:f,title:"toggle visible when tagging scenes"}),"image"==e&&d.createElement(O,{icon:T,title:"toggle visible when tagging images"}),"group"==e&&d.createElement(O,{icon:b,title:"toggle visible when tagging groups"}),"gallery"==e&&d.createElement(O,{icon:C,title:"toggle visible when tagging galleries"}),"performer"==e&&d.createElement(O,{icon:x,title:"toggle visible when tagging performers"}),"studio"==e&&d.createElement(O,{icon:I,title:"toggle visible when tagging studios"}),"tag"==e&&d.createElement(O,{icon:w,title:"toggle visible when tagging tags"}))})),this.state.edit&&d.createElement("div",{className:"mb-1"},d.createElement(u,{size:"sm"},k.map(e=>{var t;return d.createElement(c,{key:e,size:"sm",className:(null===(t=this.state.contexts)||void 0===t?void 0:t.has(e))?"btn-success":"btn-danger",onClick:()=>this.onToggleContext(e),disabled:this.props.disabled||this.state.disabled},"scene"==e&&d.createElement(O,{icon:f,title:"toggle visible when tagging scenes"}),"image"==e&&d.createElement(O,{icon:T,title:"toggle visible when tagging images"}),"group"==e&&d.createElement(O,{icon:b,title:"toggle visible when tagging groups"}),"gallery"==e&&d.createElement(O,{icon:C,title:"toggle visible when tagging galleries"}),"performer"==e&&d.createElement(O,{icon:x,title:"toggle visible when tagging performers"}),"studio"==e&&d.createElement(O,{icon:I,title:"toggle visible when tagging studios"}),"tag"==e&&d.createElement(O,{icon:w,title:"toggle visible when tagging tags"}))}))),!this.state.edit&&this.state.conditionTagId&&d.createElement("div",null,"requires tag ",null===(e=r.getTag(this.state.conditionTagId))||void 0===e?void 0:e.name),this.state.edit&&d.createElement("div",null,d.createElement(l.components.TagIDSelect,{isMulti:!1,isDisabled:this.props.disabled||this.state.disabled,creatable:!1,noSelectionString:"Required tag",ids:this.state.conditionTagId?[this.state.conditionTagId]:[],onSelect:e=>this.onConditionChanged(e?e[0].id:void 0)}))),d.createElement(g.Footer,{className:this.state.colorClass?" bg-"+this.state.colorClass:""},!this.state.edit&&d.createElement("div",{className:"row"},d.createElement("div",{className:"col-md-6"},this.state.order),d.createElement("div",{className:"col-md-6 text-right"},d.createElement(c,{size:"sm",variant:"primary",onClick:this.onEditClicked,disabled:this.props.disabled||this.state.disabled},d.createElement(O,{icon:y})))),this.state.edit&&d.createElement("div",{className:"row"},d.createElement("div",{className:"col-md-6"},d.createElement(h,{className:"mb-3 input-group-sm"},d.createElement(h.Prepend,null,this.props.onUp&&d.createElement(c,{size:"sm",onClick:this.onUpClicked,disabled:this.props.disabled||this.state.disabled},d.createElement(O,{icon:m})),this.props.onDown&&d.createElement(c,{size:"sm",onClick:this.onDownClicked,disabled:this.props.disabled||this.state.disabled},d.createElement(O,{icon:v}))),d.createElement("input",{type:"number",className:"form-control form-control-sm  text-input",value:this.state.order,min:"1",onChange:e=>this.onOrderChanged(e.target.value),disabled:this.props.disabled||this.state.disabled}))),d.createElement("div",{className:"col-md-6 text-right"},this.state.changed&&d.createElement("span",null,"*"),this.props.onRemove&&d.createElement(c,{size:"sm",variant:"danger",onClick:this.onRemoveClicked,disabled:this.props.disabled||this.state.disabled},d.createElement(O,{icon:S})))))):d.createElement(_,null)}}t.default=P},155:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});window.PluginApi;const{React:n}=window.PluginApi,o=n.createContext({});t.default=o},221:function(e,t,n){var o,a=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,a)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),s=0;s<n.length;s++)"default"!==n[s]&&a(t,e,n[s]);return i(t,e),t}),r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const l=r(n(409)),d=s(n(414));n(264);const{PluginApi:c}=window,{React:u}=c;d.initGroups(),c.patch.after("TagSelect",function(e,t,n){return u.createElement(u.Fragment,null,n,u.createElement(l.default,Object.assign({},e)))}),c.patch.before("TagLink",function(e,t){const n=d.getTagGroupForTag(e.tag);if(n&&n.colorClass){const t=(e.className?e.className+" ":"")+"bg-"+n.colorClass;e=Object.assign(Object.assign({},e),{className:t})}return[e,t]}),c.patch.after("TagCard.Title",function(e,t,n){const o=d.getTagGroupForTag(e.tag);return o&&o.colorClass?u.createElement("div",{className:"fasttagger-tag-group-color fasttagger-tag-group-color-"+o.colorClass},n):n})},264:(e,t,n)=>{n.r(t)},376:function(e,t,n){var o,a=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,a)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),s=0;s<n.length;s++)"default"!==n[s]&&a(t,e,n[s]);return i(t,e),t}),r=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(a,i){function s(e){try{l(o.next(e))}catch(e){i(e)}}function r(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,r)}l((o=o.apply(e,t||[])).next())})},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const d=l(n(868)),c=s(n(414)),u=window.PluginApi,{React:g}=window.PluginApi,{Button:p,ButtonGroup:h,Card:m,Overlay:v,OverlayTrigger:f,Popover:b}=u.libraries.Bootstrap,{faGear:T}=u.libraries.FontAwesomeSolid,{Icon:C,LoadingIndicator:E}=u.components;class y extends g.Component{constructor(e){super(e),this.loadData=()=>{console.debug("loading tags, tag groups and tag groups to tags..."),this.setState({loading:!0});const e=c.getTags().then(e=>{console.debug("done loading tags",e);const t=this.buildParentIdMap(e);this.setState({tags:e,tagIdToParentIds:t})}),t=c.getTagGroups().then(e=>{console.debug("done loading tag groups",e),this.setState({tagGroups:e})}),n=c.getTagGroupToTags().then(e=>{console.debug("done loading tag groups to tags",e),this.setState({tagGroupsToTags:e})});return Promise.all([e,t,n]).then(()=>{this.setState({loading:!1})})},this.buildParentIdMap=e=>{var t;const n=new Map;for(const o of e){n.set(o.id,new Set);for(const e of o.parents)null===(t=n.get(o.id))||void 0===t||t.add(e.id)}for(const e of n.keys())this.populateParentIdMap(e,n);return n},this.populateParentIdMap=(e,t)=>{const n=t.get(e);for(const e of n){this.populateParentIdMap(e,t).forEach(e=>n.add(e))}return n},this.onTagClick=e=>{var t,n,o,a;let i=[];this.isTagSelected(e.id)?null===(t=this.props.values)||void 0===t||t.forEach(t=>{t.id!=e.id&&i.push(t)}):(null===(n=this.props.values)||void 0===n||n.forEach(e=>{i.push(e)}),i.push(e)),null===(a=(o=this.props).onSelect)||void 0===a||a.call(o,i)},this.isTagSelected=e=>{var t;const n=null===(t=this.props.values)||void 0===t?void 0:t.findIndex(t=>t.id==e);return void 0!==n&&n>-1},this.isChildTagSelected=e=>{var t;const n=null===(t=this.props.values)||void 0===t?void 0:t.findIndex(t=>{var n,o;return null===(o=null===(n=this.state.tagIdToParentIds)||void 0===n?void 0:n.get(t.id))||void 0===o?void 0:o.has(e)});return void 0!==n&&n>-1},this.isTagExcluded=e=>!!this.state.excludeIds&&this.state.excludeIds.has(e),this.onSettingsClick=()=>{this.setState({showSettings:!0})},this.onSettingsClose=e=>{this.setState({showSettings:!1}),this.loadData()},this.maybeRenderSettingsDialog=()=>{if(this.state.showSettings)return g.createElement(d.default,{onClose:this.onSettingsClose})},this.renderTagPopover=e=>{var t;return g.createElement(b,{className:"hover-popover-content"},g.createElement(b.Content,{className:"tag-popover-card"},g.createElement("div",{className:"tag-card zoom-0 grid-card card"},g.createElement("div",{className:"thumbnail-section"},g.createElement("img",{loading:"lazy",className:"tag-card-image",alt:e.name,src:null!==(t=e.image_path)&&void 0!==t?t:""})),g.createElement("div",{className:"card-section"},g.createElement("h5",{className:"card-section-title flex-aligned"},e.name),g.createElement("div",{className:"tag-description"},e.description)))))},this.state={excludeIds:e.excludeIds?new Set(e.excludeIds):void 0}}componentDidMount(){return r(this,void 0,void 0,function*(){this.loadData()})}static getDerivedStateFromProps(e,t){return t.excludeIds=e.excludeIds?new Set(e.excludeIds):void 0,t}render(){var e;return this.state.loading?g.createElement(E,null):g.createElement("div",{className:"fast-tagger-content"},this.maybeRenderSettingsDialog(),!this.state.loading&&(null===(e=this.state.tagGroupsToTags)||void 0===e?void 0:e.filter(e=>!!e.group&&(!e.group.conditionTagId||this.isTagSelected(e.group.conditionTagId)||this.isChildTagSelected(e.group.conditionTagId))).map(e=>{var t,n,o,a,i,s;return g.createElement(m,{className:"fast-tagger-card fast-tagger-group "+((null===(t=e.group)||void 0===t?void 0:t.contexts)?null===(n=e.group)||void 0===n?void 0:n.contexts.join(" "):"all"),key:null===(o=e.group)||void 0===o?void 0:o.id},g.createElement(m.Header,{className:(null===(a=e.group)||void 0===a?void 0:a.colorClass)?" bg-"+(null===(i=e.group)||void 0===i?void 0:i.colorClass):""},null===(s=e.group)||void 0===s?void 0:s.name),g.createElement(m.Body,null,g.createElement(h,null,e.tags.map(e=>g.createElement(f,{key:e.id,placement:"right",delay:{show:250,hide:0},overlay:this.renderTagPopover(e)},g.createElement(p,{size:"sm",className:"fast-tagger-group-tag"+(this.isTagSelected(e.id)?" btn-success":this.isChildTagSelected(e.id)?" btn-light":" btn-secondary"),onClick:()=>this.onTagClick(e),disabled:this.isTagExcluded(e.id)},e._nameOverride?e._nameOverride:e.name))))))})),g.createElement("div",null,g.createElement(p,{className:"plugin-fast-tagger-settings-button",variant:"secondary",onClick:this.onSettingsClick},g.createElement(C,{icon:T})," Settings")))}}t.default=y},409:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(n(376)),i=window.PluginApi,{React:s,GQL:r}=i,{Icon:l}=i.components,{faChevronDown:d,faChevronUp:c}=i.libraries.FontAwesomeSolid;class u extends s.Component{constructor(e){super(e),this.onToggleClick=()=>{this.setState(e=>({isOpen:!e.isOpen}))},this.state={isOpen:!1}}render(){return!this.props.isMulti||!1===this.props.isClearable||!0===this.props.isDisabled||this.props.ids&&this.props.ids.length>0?s.createElement(s.Fragment,null):s.createElement(s.Fragment,null,s.createElement("div",{className:"d-flex flex-row justify-content-center"},s.createElement("div",null,s.createElement("a",{href:"javascript:void(0)",className:"plugin-fast-tagger-toggle",onClick:this.onToggleClick},!this.state.isOpen&&s.createElement(l,{icon:d}),this.state.isOpen&&s.createElement(l,{icon:c}),!this.state.isOpen&&"Open Quick Tag Editor",this.state.isOpen&&"Close Quick Tag Editor",!this.state.isOpen&&s.createElement(l,{icon:d}),this.state.isOpen&&s.createElement(l,{icon:c})))),this.state.isOpen&&s.createElement(a.default,{values:this.props.values,excludeIds:this.props.excludeIds,onSelect:this.props.onSelect}))}}t.default=u},414:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(a,i){function s(e){try{l(o.next(e))}catch(e){i(e)}}function r(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,r)}l((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0}),t.init=p,t.initGroups=v,t.applyChanges=function(){return n(this,void 0,void 0,function*(){return function(){return n(this,void 0,void 0,function*(){return window.csLib.setConfiguration("fastTagger",{groups:JSON.stringify(s),tagToGroups:JSON.stringify(l)})})}()})},t.revertChanges=function(){return n(this,void 0,void 0,function*(){return g=!1,p()})},t.resetConfig=function(){return n(this,void 0,void 0,function*(){return f()})},t.importEasyTag=function(){return n(this,void 0,void 0,function*(){return yield f(),yield p(),function(){return n(this,void 0,void 0,function*(){if(!(s.length>0))return window.csLib.getConfiguration("easytag",{Groups:"{}",Tags:"[]"}).then(e=>{if(e){const t=JSON.parse(e.Groups),n=JSON.parse(e.Tags),o=new Map;for(const e in t){const n=t[e],a={id:y(),name:n.title,order:n.order,conditionTagId:n.conditionId&&"-1"!=n.conditionId?n.conditionId:void 0};C(a),a.id&&o.set(e,a.id)}E();for(const e of n){const t=d.get(""+e.stashId);if(t&&e.group){const n=o.get(e.group);if(n){const o=r.get(n);o&&(t.groupId=o.id,t.name=e.name)}}}}})})}()})},t.exportConfig=function(){return n(this,void 0,void 0,function*(){return yield p(),function(){const e={groups:[],tagToGroups:[]};for(const t of s){const n=Object.assign({},t);if(t.conditionTagId){const e=u.get(t.conditionTagId);e&&(n.conditionTag={name:e.name,aliases:e.aliases})}e.groups.push(n)}for(const t of l){const n=Object.assign({},t),o=u.get(t.tagId);o&&(n.tag={name:o.name,aliases:o.aliases},e.tagToGroups.push(n))}return JSON.stringify(e)}()})},t.importConfig=function(e){return n(this,void 0,void 0,function*(){yield f(),yield p(),function(e){var t,n,o,a;const i=JSON.parse(e);if(i.groups)for(const e of i.groups){const o={id:e.id,name:e.name,order:e.order,contexts:e.contexts,colorClass:w(e.colorClass)};let a;e.conditionTag&&(a=S(e.conditionTag.name,e.conditionTag.aliases)),!a&&e.conditionTagId&&(a=u.get(e.conditionTagId)),a&&(console.debug('FastTagger import matched tag group "'+o.name+'" condition tag '+e.conditionTagId+' "'+(null===(t=e.conditionTag)||void 0===t?void 0:t.name)+'" '+(null===(n=e.conditionTag)||void 0===n?void 0:n.aliases)+" to "+a.id+' "'+a.name+'"'),o.conditionTagId=a.id),C(o)}if(i.tagToGroups)for(var s of i.tagToGroups){let e;if(s.tag&&(e=S(s.tag.name,s.tag.aliases)),e||(e=u.get(s.tagId)),!e)continue;const t=d.get(e.id);t&&(console.debug("FastTagger import matched tag "+s.tagId+' "'+s.name+'" "'+(null===(o=s.tag)||void 0===o?void 0:o.name)+'" '+(null===(a=s.tag)||void 0===a?void 0:a.aliases)+" to "+e.id+' "'+e.name+'"'),t.name=s.name,t.groupId=s.groupId)}}(e)})},t.getTagGroups=function(){return n(this,void 0,void 0,function*(){return yield p(),s})},t.addTagGroup=function(e){return n(this,void 0,void 0,function*(){yield p(),e.id=y(),s.length>0?e.order=s[s.length-1].order+1:e.order=1,C(e)})},t.removeTagGroup=function(e){return n(this,void 0,void 0,function*(){if(yield p(),!e.id)return;const t=s.findIndex(t=>t.id==e.id);if(!(t<0)){s.splice(t,1),r.delete(e.id);for(const t of l)t.groupId==e.id&&(t.groupId=void 0);E()}})},t.updateTagGroup=function(e,t,o,a,i){return n(this,void 0,void 0,function*(){yield p();const n=s.findIndex(t=>t.id==e.id);if(n<0)return;const r=s[n];r.name=t,r.conditionTagId=o,r.contexts=a,r.colorClass=i})},t.moveTagGroupUp=function(e){return n(this,void 0,void 0,function*(){yield p();const t=s.findIndex(t=>t.id==e.id);if(t<0)return;if(0==t)return;const n=s[t-1].order;s[t-1].order=s[t].order,s[t].order=n,E()})},t.moveTagGroupDown=function(e){return n(this,void 0,void 0,function*(){yield p();const t=s.findIndex(t=>t.id==e.id);if(t<0)return;if(t==s.length-1)return;const n=s[t+1].order;s[t+1].order=s[t].order,s[t].order=n,E()})},t.moveTagGroupTo=function(e,t){return n(this,void 0,void 0,function*(){yield p();const n=s.findIndex(t=>t.id==e.id);if(n<0)return;const o=t<n+1;s[n].order=t+(o?0:1);for(let e=Math.max(o?t-1:t,0);e<s.length;e++)e!=n&&(s[e].order+=1);E()})},t.getTagGroupToTags=function(){return n(this,void 0,void 0,function*(){var e;yield p();const t=new Map,n=[];for(const e of s){if(!e.id)continue;const o={group:e,tags:[]};t.set(e.id,o),n.push(o)}const o={group:void 0,tags:[]};t.set("_",o),n.push(o);for(const n of l){n.groupId&&r.get(n.groupId);const o=u.get(n.tagId);if(o){const a=Object.assign({},o);a._nameOverride=n.name,a._tagGroupId=n.groupId,null===(e=t.get(n.groupId?n.groupId:"_"))||void 0===e||e.tags.push(a)}}for(const e of t.values())e.tags.sort((e,t)=>{const n=(e.sort_name?e.sort_name:"")+e.name,o=(t.sort_name?t.sort_name:"")+t.name;return n.localeCompare(o)});return n})},t.getTags=function(){return n(this,void 0,void 0,function*(){return yield p(),c})},t.getTag=function(e){if(!e)return;return u.get(e)},t.findTagByNameOrAlias=S,t.getTagGroupForTag=function(e){if(!e)return;const t=d.get(e.id);if(!t||!t.groupId)return;const n=r.get(t.groupId);return n},t.moveTagToGroup=function(e,t){return n(this,void 0,void 0,function*(){const n=d.get(e.id);n&&(n.groupId=null==t?void 0:t.id)})},t.updateTag=function(e,t){return n(this,void 0,void 0,function*(){const n=d.get(e.id);n&&(n.name=t)})};const{GQL:o}=window.PluginApi,{StashService:a}=window.PluginApi.utils;let i,s=[],r=new Map,l=[],d=new Map,c=[],u=new Map,g=(new Map,!1);function p(){return n(this,void 0,void 0,function*(){if(!g)return i||(i=new Promise((e,t)=>{console.debug("initializing fast tagger data"),v().then(()=>{(function(){return n(this,void 0,void 0,function*(){return c=[],u.clear(),a.queryFindTagsForSelect({makeFindFilter:()=>({sort:"name",page:1,per_page:99999}),makeFilter:()=>({})}).then(e=>{const t=e.data.findTags.tags,n=new Map(Object.keys(d).map(e=>[e,!1]));for(const e of t)b(e),n.get(e.id)&&n.delete(e.id);if(n.size>0)for(const e of Object.keys(n))T(e);c.sort((e,t)=>{const n=(e.sort_name?e.sort_name:"")+e.name,o=(t.sort_name?t.sort_name:"")+t.name;return n.localeCompare(o)})})})})().then(()=>{g=!0,i=void 0,e()})})}),i)})}let h,m=!1;function v(){return n(this,void 0,void 0,function*(){if(!m)return h||(h=new Promise((e,t)=>{console.debug("initializing fast tagger groups"),function(){return n(this,void 0,void 0,function*(){return s=[],r.clear(),l=[],d.clear(),window.csLib.getConfiguration("fastTagger",{groups:"[]",tagToGroups:"[]"}).then(e=>{if(e){for(var t of(s=JSON.parse(e.groups),s))t.id&&(t.colorClass=w(t.colorClass),r.set(t.id,t));for(var n of(l=JSON.parse(e.tagToGroups),l))d.set(""+n.tagId,n)}})})}().then(()=>{m=!0,h=void 0,e()})}),h)})}function f(){return n(this,void 0,void 0,function*(){yield window.csLib.setConfiguration("fastTagger",{groups:"[]",tagToGroups:"[]"}),s=[],r.clear(),l=[],d.clear(),g=!1})}function b(e){if(c.push(e),u.set(e.id,e),!d.get(""+e.id)){const t={tagId:e.id};l.push(t),d.set(""+e.id,t)}}function T(e){const t=d.get(e);if(!t)return;const n=l.indexOf(t);l.splice(n,1),d.delete(""+e)}function C(e){e.id&&(s.push(e),r.set(e.id,e))}function E(){s.sort((e,t)=>e.order-t.order);let e=0;for(const t of s)e++,t.order=e}const y=()=>{let e="";for(;e.length<32;)e+=Math.random().toString(16).substr(2);const t=(3&parseInt(e.substr(16,1),16)|8).toString(16);return`${e.substr(0,8)}-${e.substr(8,4)}-4${e.substr(13,3)}-${t}${e.substr(17,3)}-${e.substr(20,12)}`};function w(e){return"primary"==e?"blue":"secondary"==e?"gray":"success"==e?"green":"warning"==e?"orange":"danger"==e?"red":"info"==e?"cyan":"warning"==e?"orange":"light"==e||"light"==e?"white":e}function S(e,t){return c.find(n=>e&&(n.name.toLowerCase()==e.toLowerCase()||n.aliases.findIndex(t=>t.toLowerCase()==e.toLowerCase())>-1)||t&&t.findIndex(e=>n.name.toLowerCase()==e.toLowerCase()||n.aliases.findIndex(t=>e.toLowerCase()==t.toLowerCase())>-1)>-1)}},436:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ModalComponent=void 0;const n=window.PluginApi,{React:o}=n,{Button:a,Modal:i,Spinner:s}=n.libraries.Bootstrap,{FormattedMessage:r}=n.libraries.Intl,l=()=>{};t.ModalComponent=({children:e,show:t,icon:n,header:d,cancel:c,accept:u,onHide:g,isRunning:p,disabled:h,modalProps:m,dialogClassName:v,footerButtons:f,leftFooterButtons:b})=>{var T,C,E,y;return o.createElement(i,Object.assign({className:"ModalComponent",keyboard:!1,onHide:null!=g?g:l,show:t,dialogClassName:v},m),o.createElement(i.Header,null,o.createElement("span",null,null!=d?d:"")),o.createElement(i.Body,null,e),o.createElement(i.Footer,{className:"ModalFooter"},o.createElement("div",null,null==b?void 0:b.map((e,t)=>{var n,i;return o.createElement(a,{key:""+t,disabled:p,variant:null!==(n=e.variant)&&void 0!==n?n:"primary",onClick:e.onClick,className:"ml-2"},null!==(i=e.text)&&void 0!==i?i:o.createElement(r,{id:e.textId,defaultMessage:e.text,description:e.description}))})),o.createElement("div",null,null==f?void 0:f.map(e=>{var t,n;return o.createElement(a,{disabled:p,variant:null!==(t=e.variant)&&void 0!==t?t:"primary",onClick:e.onClick,className:"ml-2"},null!==(n=e.text)&&void 0!==n?n:o.createElement(r,{id:e.textId,defaultMessage:e.text,description:e.description}))}),c?o.createElement(a,{disabled:p,variant:null!==(T=c.variant)&&void 0!==T?T:"primary",onClick:c.onClick,className:"ml-2"},null!==(C=c.text)&&void 0!==C?C:o.createElement(r,{id:"actions.cancel",defaultMessage:"Cancel",description:"Cancels the current action and dismisses the modal."})):"",o.createElement(a,{disabled:p||h,variant:null!==(E=null==u?void 0:u.variant)&&void 0!==E?E:"primary",onClick:null==u?void 0:u.onClick,className:"ml-2"},p?o.createElement(s,{animation:"border",role:"status",size:"sm"}):null!==(y=null==u?void 0:u.text)&&void 0!==y?y:o.createElement(r,{id:"actions.close",defaultMessage:"Close",description:"Closes the current modal."})))))}},842:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=window.PluginApi,{React:o}=window.PluginApi,{Card:a,Dropdown:i}=n.libraries.Bootstrap,{LoadingIndicator:s}=n.components;let{TagLink:r}=n.components;r||n.utils.loadComponents([n.loadableComponents.TagLink]).then(()=>{r=n.components.TagLink});class l extends o.PureComponent{constructor(e){super(e),this.onNameChanged=e=>{this.setState({name:e,changed:!0})},this.onFocusLost=()=>{this.state.changed&&this.props.onChanged&&this.props.onChanged(this.state.name)},this.onTagMove=e=>{this.props.onMoveTagToGroup(e)},this.state={name:e.item._nameOverride}}render(){var e;return r?o.createElement(a,{className:"fast-tagger-card"},o.createElement(a.Body,null,o.createElement("div",{className:"d-flex flex-direction-row justify-content-between align-items-center"},o.createElement("div",{className:"flex-grow-1 mr-3"},o.createElement("div",null,o.createElement(r,{tag:this.props.item,linkType:"details"})),o.createElement("div",null,o.createElement("input",{type:"text",className:"form-control form-control-sm  text-input",value:this.state.name,onChange:e=>this.onNameChanged(e.target.value),onBlur:e=>this.onFocusLost()}))),o.createElement("div",null,o.createElement(i,null,o.createElement(i.Toggle,{variant:"primary",size:"sm"},"Move to"),o.createElement(i.Menu,null,null===(e=this.props.tagGroups)||void 0===e?void 0:e.filter(e=>{var t,n;return(null===(t=e.group)||void 0===t?void 0:t.id)&&(null===(n=e.group)||void 0===n?void 0:n.id)!=this.props.item._tagGroupId}).map(e=>{var t,n;return o.createElement(i.Item,{key:null===(t=e.group)||void 0===t?void 0:t.id,onClick:()=>this.onTagMove(e.group)},null===(n=e.group)||void 0===n?void 0:n.name)}),this.props.tagGroups&&this.props.tagGroups.length>0&&o.createElement(i.Divider,null),o.createElement(i.Item,{key:"ungrouped",onClick:()=>this.onTagMove(void 0)},"No group"))))))):o.createElement(s,null)}}t.default=l},868:function(e,t,n){var o,a=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,a)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),s=0;s<n.length;s++)"default"!==n[s]&&a(t,e,n[s]);return i(t,e),t}),r=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(a,i){function s(e){try{l(o.next(e))}catch(e){i(e)}}function r(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,r)}l((o=o.apply(e,t||[])).next())})},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const d=n(436),c=l(n(155)),u=l(n(842)),g=l(n(23)),p=s(n(414)),h=window.PluginApi,{React:m}=h,{Button:v,Card:f,Tabs:b,Tab:T}=h.libraries.Bootstrap,{LoadingIndicator:C}=h.components;class E extends m.Component{constructor(e){super(e),this.loadData=()=>{this.setState({loading:!0});const e=this.doLoadTags(),t=this.doLoadGroups(),n=this.doLoadTagGroupsToTags();return Promise.all([e,t,n]).then(()=>{this.setState({loading:!1})})},this.loadGroups=()=>r(this,void 0,void 0,function*(){return this.setState({loading:!0}),this.doLoadGroups().then(()=>{this.setState({loading:!1})})}),this.loadTagGroupsToTags=()=>r(this,void 0,void 0,function*(){return this.setState({loading:!0}),this.doLoadTagGroupsToTags().then(()=>{this.setState({loading:!1})})}),this.doLoadTags=()=>r(this,void 0,void 0,function*(){return p.getTags().then(e=>{console.debug("done loading tags",e);const t=new Map;for(const n of e)t.set(n.id,n);this.setState({tags:e,tagIdToTag:t})})}),this.doLoadGroups=()=>r(this,void 0,void 0,function*(){return p.getTagGroups().then(e=>{console.debug("done loading tag groups",e),this.setState({tagGroups:e})})}),this.doLoadTagGroupsToTags=()=>r(this,void 0,void 0,function*(){return p.getTagGroupToTags().then(e=>{console.debug("done loading tag groups to tags",e),this.setState({tagGroupsToTags:e})})}),this.onTagMove=(e,t)=>{this.setState({saving:!0}),p.moveTagToGroup(e,t).then(()=>{this.loadTagGroupsToTags().then(()=>{this.setState({saving:!1})})})},this.onTagChanged=(e,t)=>{this.setState({saving:!0}),p.updateTag(e,t).then(()=>{this.setState({saving:!1})})},this.onGroupAdd=()=>{this.setState({saving:!0}),p.addTagGroup({order:99999}).then(()=>{this.loadGroups().then(()=>{this.setState({saving:!1})})})},this.onClear=()=>{this.setState({saving:!0}),p.resetConfig().then(()=>{this.loadData().then(()=>{this.setState({saving:!1})})})},this.onGroupUp=e=>{this.setState({saving:!0}),p.moveTagGroupUp(e).then(()=>{this.loadGroups().then(()=>{this.setState({saving:!1})})})},this.onGroupDown=e=>{this.setState({saving:!0}),p.moveTagGroupDown(e).then(()=>{this.loadGroups().then(()=>{this.setState({saving:!1})})})},this.onGroupOrder=(e,t)=>{this.setState({saving:!0}),p.moveTagGroupTo(e,t).then(()=>{this.loadGroups().then(()=>{this.setState({saving:!1})})})},this.onGroupRemove=e=>{this.setState({saving:!0}),p.removeTagGroup(e).then(()=>{this.loadGroups().then(()=>{this.setState({saving:!1})})})},this.onGroupChanged=(e,t,n,o,a)=>(this.setState({saving:!0}),p.updateTagGroup(e,t,n,o,a).then(()=>{this.setState({saving:!1})})),this.onActiveTabChanged=e=>{this.setState({activeTab:e})},this.onApply=()=>{this.setState({saving:!0}),p.applyChanges().then(()=>{this.setState({saving:!1}),this.props.onClose(!0)})},this.onCancel=()=>{this.setState({saving:!0}),p.revertChanges().then(()=>{this.setState({saving:!1}),this.props.onClose()})},this.onExportConfig=()=>{this.setState({saving:!0}),p.exportConfig().then(e=>{let t=new Blob([e],{type:"json"}),n=document.createElement("a");n.download="FastTigger.config.json",n.href=URL.createObjectURL(t),n.dataset.downloadurl=["json",n.download,n.href].join(":"),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout(function(){URL.revokeObjectURL(n.href)},1500),this.setState({saving:!1})})},this.onImportConfig=()=>{var e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=e=>{this.setState({saving:!0});var t=e.target.files[0],n=new FileReader;n.readAsText(t,"UTF-8"),n.onload=e=>{p.importConfig(e.target.result).then(()=>{this.setState({saving:!1}),this.loadData()})}},e.click()},this.onImportEasyTagConfig=()=>{this.setState({saving:!0}),p.importEasyTag().then(()=>{this.setState({saving:!1}),this.loadData()})},this.state={loading:!0,activeTab:"groups"}}componentDidMount(){return r(this,void 0,void 0,function*(){this.loadData()})}render(){var e,t;return m.createElement(d.ModalComponent,{show:!0,isRunning:this.state.loading||this.state.saving,header:"Settings",accept:{onClick:this.onApply,text:"Apply"},cancel:{onClick:this.onCancel,text:"Cancel",variant:"secondary"},modalProps:{size:"xl",dialogClassName:"scrape-dialog"},leftFooterButtons:[{text:"Clear Config",variant:"danger",onClick:this.onClear},{text:"Download Config",variant:"secondary",onClick:this.onExportConfig},{text:"Upload Config",variant:"secondary",onClick:this.onImportConfig},{text:"Import from EasyTag",variant:"secondary",onClick:this.onImportEasyTagConfig}]},this.state.loading&&m.createElement(C,null),!this.state.loading&&m.createElement(c.default.Provider,{value:{tags:this.state.tags,tagIdToTag:this.state.tagIdToTag}},m.createElement(b,{defaultActiveKey:"groups",justify:!0,activeKey:this.state.activeTab,onSelect:this.onActiveTabChanged},m.createElement(T,{eventKey:"tags",title:"Tags"},"tags"==this.state.activeTab&&(null===(e=this.state.tagGroupsToTags)||void 0===e?void 0:e.map(e=>{var t,n,o;return m.createElement(f,{className:"fast-tagger-card",key:e.group?null===(t=e.group)||void 0===t?void 0:t.id:"ungrouped"},m.createElement(f.Header,{className:(null===(n=e.group)||void 0===n?void 0:n.colorClass)?" bg-"+(null===(o=e.group)||void 0===o?void 0:o.colorClass):""},e.group?e.group.name:"Ungrouped tags"),m.createElement(f.Body,null,m.createElement("div",{className:"row"},e.tags.map(e=>m.createElement("div",{className:"col-12 col-md-6 col-lg-4",key:e.id},m.createElement(u.default,{item:e,tagGroups:this.state.tagGroupsToTags,onMoveTagToGroup:t=>this.onTagMove(e,t),onChanged:t=>this.onTagChanged(e,t)}))))))}))),m.createElement(T,{eventKey:"groups",title:"Groups"},m.createElement("div",{className:"row"},"groups"==this.state.activeTab&&(null===(t=this.state.tagGroups)||void 0===t?void 0:t.map(e=>m.createElement("div",{className:"col-sm-12 col-md-6 col-lg-4",key:e.id},m.createElement(g.default,{item:e,onUp:()=>this.onGroupUp(e),onDown:()=>this.onGroupDown(e),onOrder:t=>this.onGroupOrder(e,t),onRemove:()=>this.onGroupRemove(e),onChanged:(t,n,o,a)=>this.onGroupChanged(e,t,n,o,a),disabled:this.state.saving}))))),m.createElement("div",null,m.createElement(v,{variant:"primary",onClick:this.onGroupAdd},"Add"))))))}}t.default=E}},t={};function n(o){var a=t[o];if(void 0!==a)return a.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,n),i.exports}n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};n(221)})();